<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BAI ‚Äì Invent√°rio de Ansiedade de Beck</title>
<style>
  :root{
    /* TEMA CLARO (padr√£o) */
    --bg:#f3f4f6;
    --card:#ffffff;
    --line:#e5e7eb;
    --text:#0f172a;
    --muted:#6b7280;
    --pri:#4f46e5;
    --ok:#16a34a;
    --err:#b91c1c;
    --surface:#f9fafb;
    --chip:#eef2ff;
    --ok-bg:#ecfdf3;
    --ok-border:#bbf7d0;
    --ok-text:#166534;
    --err-bg:#fef2f2;
    --err-border:#fecaca;
    --err-text:#7f1d1d;
    --warn-bg:#fffbeb;
    --warn-border:#fef3c7;
    --warn-text:#92400e;
  }

  /* TEMA ESCURO */
  [data-theme="dark"]{
    --bg:#0f172a;
    --card:#111827;
    --line:#1f2937;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --pri:#4f46e5;
    --ok:#22c55e;
    --err:#ef4444;
    --surface:#0b1220;
    --chip:#020617;
    --ok-bg:#052e1a;
    --ok-border:#114d2a;
    --ok-text:#b3f7c1;
    --err-bg:#3b0d0d;
    --err-border:#5b1919;
    --err-text:#ffd0d0;
    --warn-bg:#3a2903;
    --warn-border:#5b4307;
    --warn-text:#ffe6b0;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    transition:background .2s ease,color .2s ease;
  }
  .wrap{max-width:960px;margin:24px auto;padding:0 16px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:18px;
    box-shadow:0 18px 40px rgba(15,23,42,.15);
  }

  .header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin-bottom:6px;
  }
  .header-main{flex:1 1 auto}
  h1{margin:0 0 6px;font-size:1.35rem}
  .muted{color:var(--muted);margin:0}
  @media(max-width:600px){
    .header{flex-direction:column-reverse;align-items:flex-start}
  }

  .theme-btn{
    align-self:flex-start;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:transparent;
    color:var(--text);
    font-size:.85rem;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
    white-space:nowrap;
  }
  .theme-btn:hover{background:var(--surface)}

  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0 6px}
  @media(max-width:720px){.grid-info{grid-template-columns:1fr}}

  .info{
    background:var(--surface);
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px;
  }
  .info b{
    display:block;
    margin-bottom:4px;
    color:var(--muted);
    font-size:.8rem;
    text-transform:uppercase;
    letter-spacing:.03em;
  }

  .q{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    background:var(--surface);
    margin-bottom:10px;
  }
  .q h3{margin:0 0 8px;font-size:1rem}

  .opts{display:flex;flex-wrap:wrap;gap:10px}
  .opt{
    display:flex;
    align-items:center;
    gap:6px;
    padding:8px 10px;
    border:1px solid var(--line);
    border-radius:10px;
    background:var(--chip);
    font-size:.9rem;
  }
  .opt input{margin:0}

  .btn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    background:var(--pri);
    border:none;
    color:#fff;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:500;
  }
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .msg{margin:10px 0;padding:10px;border-radius:8px;font-size:.9rem}
  .okbox{
    background:var(--ok-bg);
    border:1px solid var(--ok-border);
    color:var(--ok-text);
  }
  .errbox{
    background:var(--err-bg);
    border:1px solid var(--err-border);
    color:var(--err-text);
  }
  .warnbox{
    background:var(--warn-bg);
    border:1px solid var(--warn-border);
    color:var(--warn-text);
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div class="header-main">
        <h1>BAI ‚Äì Invent√°rio de Ansiedade de Beck</h1>
        <p class="muted">Marque o quanto cada sintoma lhe incomodou na <strong>√∫ltima semana</strong>, incluindo hoje.</p>
      </div>
      <button id="themeToggle" class="theme-btn" type="button">üåô Modo escuro</button>
    </div>

    <!-- Dados do paciente (preenchidos via token) -->
    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="margin-top:14px; display:none;">
      <div id="qs"></div>
      <div style="margin-top:14px">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
// ======== CONFIG ========
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_BAI" };
const CODE = "BAI";

// Hub para onde voltar com o token
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";

// ======== HELPERS ========
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";

// ======== TEMA CLARO/ESCURO ========
const THEME_KEY = "bai_theme";

function applyTheme(theme){
  const root = document.documentElement;
  root.setAttribute("data-theme", theme);
  const btn = $("#themeToggle");
  if(btn){
    btn.textContent = theme === "dark" ? "‚òÄÔ∏è Modo claro" : "üåô Modo escuro";
  }
}

function initTheme(){
  let theme = "light";
  try{
    const saved = localStorage.getItem(THEME_KEY);
    if(saved === "dark" || saved === "light") theme = saved;
  }catch(_){}
  applyTheme(theme);

  const btn = $("#themeToggle");
  if(btn){
    btn.addEventListener("click", ()=>{
      const current = document.documentElement.getAttribute("data-theme") || "light";
      const next = current === "dark" ? "light" : "dark";
      applyTheme(next);
      try{ localStorage.setItem(THEME_KEY, next); }catch(_){}
    });
  }
}

if(document.readyState === "loading"){
  document.addEventListener("DOMContentLoaded", initTheme);
}else{
  initTheme();
}

function setBox(id, text, kind="ok"){
  const el = $(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display = "block";
}
function hideBox(id){
  const el=$(id); if(el){
    el.style.display="none";
    el.textContent="";
  }
}
function maskCPF(cpf){
  const d = onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  if(!y||!m||!d) return iso;
  return `${d}/${m}/${y}`;
}

async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data:[row] })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const r = await fetch(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, {
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

// voltar ao portal com o mesmo token
function goPortalWithToken(){
  const TOKEN = qs("token");
  try{
    const u = new URL(PORTAL_URL, location.href);
    u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + sep + "token=" + encodeURIComponent(TOKEN);
  }
}

// ======== ITENS/OP√á√ïES ========
const ITEMS = [
  "Dorm√™ncia ou formigamento.",
  "Sensa√ß√£o de calor.",
  "Tremores nas pernas.",
  "Incapaz de relaxar.",
  "Medo que aconte√ßa o pior.",
  "Atordoado ou tonto.",
  "Palpita√ß√£o ou acelera√ß√£o do cora√ß√£o.",
  "Sem equil√≠brio.",
  "Aterrorizado.",
  "Nervoso.",
  "Sensa√ß√£o de sufoca√ß√£o.",
  "Tremores nas m√£os.",
  "Tr√™mulo.",
  "Medo de perder o controle.",
  "Dificuldade de respirar.",
  "Medo de morrer.",
  "Assustado.",
  "Indigest√£o ou desconforto no abd√¥men.",
  "Sensa√ß√£o de desmaio.",
  "Rosto afogueado.",
  "Suor (n√£o devido ao calor)."
];

const CHOICES = [
  {label:"Absolutamente n√£o", value:0},
  {label:"Levemente",         value:1},
  {label:"Moderadamente",     value:2},
  {label:"Gravemente",        value:3},
];

// categoriza√ß√£o cl√≠nica padr√£o
function categoria(total){
  if(total <= 10) return "m√≠nimo";
  if(total <= 19) return "leve";
  if(total <= 30) return "moderada";
  return "severa";
}

function renderQuestions(){
  const host = $("#qs"); host.innerHTML="";
  ITEMS.forEach((text, idx)=>{
    const qn = String(idx+1).padStart(2,"0");
    const wrap = document.createElement("div");
    wrap.className="q";
    wrap.innerHTML = `<h3>${idx+1}. ${text}</h3>`;

    const opts = document.createElement("div");
    opts.className="opts";

    CHOICES.forEach(c=>{
      const id=`q${qn}_${c.value}`;
      const lab=document.createElement("label"); lab.className="opt";
      lab.innerHTML = `
        <input type="radio" name="q${qn}" id="${id}" value="${c.value}" required>
        <span>${c.label}</span>
      `;
      opts.appendChild(lab);
    });

    wrap.appendChild(opts);
    host.appendChild(wrap);
  });
}

// ======== ESTADO ========
let patient = null;     // linha de Patients
let tokenRow = null;    // linha de LinkTokens
let CPF = "";           // do token

// ======== BOOT POR TOKEN ========
(async function boot(){
  try{
    const TOKEN = qs("token");
    if(!TOKEN){
      setBox("#alert","Link inv√°lido (sem token). Solicite um novo link.","err");
      return;
    }

    // 1) valida token
    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inv√°lido ou expirado.");
    tokenRow = trows[0];

    const disabled = String(tokenRow.disabled||"n√£o").toLowerCase()==="sim";
    const expired  = tokenRow.expires_at && (new Date(tokenRow.expires_at) < new Date());
    if(disabled || expired) throw new Error("Token desativado/expirado. Pe√ßa um novo link.");

    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    // 2) carrega paciente
    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente n√£o encontrado.");
    patient = prows[0];

    // 3) verifica libera√ß√£o
    const allowed = String(patient[CODE]||"").toLowerCase()==="sim";
    if(!allowed){
      setBox("#alert","Este formul√°rio n√£o est√° liberado para voc√™. Entre em contato com o consult√≥rio.","err");
      return;
    }

    // 4) bloqueia se j√° fez
    const flagDone = String(patient[`${CODE}_FEITO`]||"").toLowerCase()==="sim";
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(flagDone || (already && already.length)){
      setBox("#alert","Voc√™ j√° respondeu este formul√°rio. Voltando ao portal‚Ä¶","ok");
      setTimeout(goPortalWithToken, 1200);
      return;
    }

    // 5) render dados + perguntas
    renderPatientInfo();
    renderQuestions();
    $("#pacInfo").style.display = "grid";
    $("#form").style.display = "block";
    hideBox("#alert");

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formul√°rio. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g = $("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["CPF", maskCPF(patient.cpf)],
    ["Nascimento", fmtDateISO(patient.data_nascimento)],
    ["E-mail", patient.email || "-"],
    ["WhatsApp", patient.whatsapp || "-"],
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

// ======== SUBMIT (com trava contra clique duplo) ========
let sending = false;

$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending = true;
  hideBox("#msg");

  const btn = $("#btnSubmit");
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Enviando‚Ä¶";

  try{
    if(!patient) throw new Error("Sess√£o inv√°lida. Recarregue o link.");

    // coleta respostas e soma total
    let total = 0;
  const qaList = []; // ser√° salvo em 'questions' no formato { "Pergunta": "Resposta" }
for(let i=1;i<=ITEMS.length;i++){
  const qn = String(i).padStart(2,"0");
  const sel = document.querySelector(`input[name="q${qn}"]:checked`);
  if(!sel){
    throw new Error(`Responda a quest√£o ${i}.`);
  }
  const rawVal = Number(sel.value); // 0..3
  total += rawVal;

  const choice = CHOICES.find(o=>o.value===rawVal);
  const obj = {};
  obj[ITEMS[i-1]] = choice ? choice.label : String(rawVal);
  qaList.push(obj);
}


    const cat = categoria(total); // m√≠nimo/leve/moderada/severa

    // salva score completo (questions = s√≥ perguntas + respostas)
    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: qs("token"),
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total,
      categoria: cat,
      metrics: "",
      questions: JSON.stringify(qaList)
    });

    // marca como FEITO
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, {
      [`${CODE}_FEITO`]: "sim"
    });

    setBox("#msg","Formul√°rio enviado. Voltando ao portal‚Ä¶","ok");
    setTimeout(goPortalWithToken, 1000);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending = false;
    btn.disabled = false;
    btn.textContent = originalText;
  }
});
</script>
</body>
</html>
